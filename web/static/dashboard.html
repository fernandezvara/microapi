<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Micro API Dashboard</title>
    <script>
      try {
        const root = document.documentElement;
        let theme = localStorage.getItem("theme");
        if (!theme) {
          const prefersDark =
            window.matchMedia &&
            window.matchMedia("(prefers-color-scheme: dark)").matches;
          theme = prefersDark ? "dark" : "light";
          try {
            localStorage.setItem("theme", theme);
          } catch {}
        }
        if (theme === "dark") {
          root.classList.add("dark");
        } else {
          root.classList.remove("dark");
        }
        // Expose a single setter to keep DOM and storage in sync
        window.setTheme = function (next) {
          try {
            localStorage.setItem("theme", next);
          } catch {}
          if (next === "dark") {
            root.classList.add("dark");
          } else {
            root.classList.remove("dark");
          }
        };
      } catch (e) {}
      window.tailwind = window.tailwind || {};
      tailwind = window.tailwind; // ensure global alias
      tailwind.config = { darkMode: "class" };
    </script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body
    class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100"
    x-data="dashboard()"
    x-init="init()"
  >
    <!-- Main Container -->
    <div class="flex h-screen">
      <!-- Sidebar -->
      <div
        class="w-64 bg-white border-r border-gray-200 dark:bg-gray-800 dark:border-gray-700"
      >
        <div class="p-6">
          <h1 class="text-2xl font-bold flex items-center gap-2">
            <img
              src="/logo.svg"
              alt="Micro API logo"
              style="width: 32px; height: 32px"
            />
            <span class="text-amber-400">Micro API</span>
          </h1>
          <p class="text-xs text-gray-400 mt-1">Schema-less JSON Storage</p>
        </div>

        <!-- Navigation -->
        <nav class="px-4">
          <button
            @click="currentView = 'overview'"
            :class="currentView === 'overview' ? 'bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-white' : 'text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white'"
            class="w-full flex items-center px-4 py-3 rounded-lg mb-2 transition-all"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              aria-hidden="true"
              data-slot="icon"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"
              />
            </svg>
            <span class="ml-3">Overview</span>
          </button>

          <button
            @click="currentView = 'explorer'"
            :class="currentView === 'explorer' ? 'bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-white' : 'text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white'"
            class="w-full flex items-center px-4 py-3 rounded-lg mb-2 transition-all"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              aria-hidden="true"
              data-slot="icon"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125"
              />
            </svg>
            <span class="ml-3">Data Explorer</span>
          </button>

          <button
            @click="currentView = 'query'"
            :class="currentView === 'query' ? 'bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-white' : 'text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white'"
            class="w-full flex items-center px-4 py-3 rounded-lg mb-2 transition-all"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              aria-hidden="true"
              data-slot="icon"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"
              />
            </svg>
            <span class="ml-3">Query Builder</span>
          </button>

          <button
            @click="currentView = 'api'"
            :class="currentView === 'api' ? 'bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-white' : 'text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white'"
            class="w-full flex items-center px-4 py-3 rounded-lg mb-2 transition-all"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              aria-hidden="true"
              data-slot="icon"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M17.25 6.75 22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3-4.5 16.5"
              />
            </svg>
            <span class="ml-3">API Tester</span>
          </button>
        </nav>

        <!-- Sets List -->
        <div class="px-4 mt-8">
          <h3 class="text-xs uppercase text-gray-500 font-semibold mb-3">
            Sets
          </h3>
          <div class="space-y-1">
            <template x-for="set in sets" :key="set.name">
              <button
                @click="selectSet(set)"
                :class="selectedSet?.name === set.name ? 'bg-amber-600 text-white' : 'text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white'"
                class="w-full text-left px-3 py-2 rounded-lg text-sm transition-all flex justify-between items-center"
              >
                <span x-text="set.name"></span>
                <span
                  class="text-xs opacity-60"
                  x-text="((set.colls ?? (set.collections?.length || 0)) + ' cols')"
                ></span>
              </button>
            </template>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col min-h-0">
        <!-- Header -->
        <header
          class="bg-white border-b border-gray-200 dark:bg-gray-800 dark:border-gray-700 px-8 py-4"
        >
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-xl font-semibold" x-text="getTitle()"></h2>
              <div
                class="flex items-center mt-1 text-sm text-gray-400"
                x-show="selectedSet"
              >
                <span x-text="selectedSet?.name"></span>
                <template x-if="selectedCollection">
                  <span class="inline-flex items-center">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="w-3 h-3 mx-2"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                      aria-hidden="true"
                      data-slot="icon"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="m8.25 4.5 7.5 7.5-7.5 7.5"
                      />
                    </svg>
                    <span x-text="selectedCollection"></span>
                  </span>
                </template>
              </div>
            </div>
            <div class="flex gap-3 items-center">
              <button
                @click="showNewDocModal = true"
                class="inline-flex items-center px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg text-sm font-medium transition-colors"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-4 h-4 mr-2"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  aria-hidden="true"
                  data-slot="icon"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M12 4.5v15m7.5-7.5h-15"
                  />
                </svg>
                New Document
              </button>
              <button
                @click="toggleTheme()"
                :title="isDark ? 'Switch to light' : 'Switch to dark'"
                :aria-pressed="isDark.toString()"
                class="px-3 py-2 bg-white hover:bg-gray-300 text-gray-800 rounded-lg text-sm font-medium transition-colors dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-100"
              >
                <svg
                  x-show="!isDark"
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  aria-hidden="true"
                  data-slot="icon"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z"
                  />
                </svg>
                <svg
                  x-show="isDark"
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  aria-hidden="true"
                  data-slot="icon"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z"
                  />
                </svg>
              </button>

              <button
                @click="openHealthModal()"
                :title="healthOk === false ? ('Health error: ' + (lastHealthError || '')) : 'View health'"
                class="px-4 py-2 bg-white hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-lg text-sm font-medium transition-colors"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  aria-hidden="true"
                  data-slot="icon"
                  :class="healthOk === true ? 'text-green-500' : (healthOk === false ? 'text-red-500' : 'text-gray-400')"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z"
                  />
                </svg>
              </button>
              <span
                x-show="serverVersion"
                class="px-2 py-1 text-xs rounded bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200 font-medium select-all"
                x-text="serverVersion == 'dev' ? 'v: dev' : serverVersion"
              ></span>
            </div>
          </div>
        </header>

        <!-- Health Banner -->
        <div
          x-show="healthOk === false"
          x-cloak
          class="bg-red-50 dark:bg-red-900/30 border-b border-red-200 dark:border-red-800"
        >
          <div
            class="px-8 py-3 text-red-700 dark:text-red-200 flex items-center justify-between"
          >
            <div class="flex items-center">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5 text-red-500 dark:text-red-400"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
                aria-hidden="true"
                data-slot="icon"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z"
                />
              </svg>
              <span class="ml-2"
                >Health check failed: <span x-text="lastHealthError"></span
              ></span>
            </div>
            <button
              @click="checkHealth()"
              class="inline-flex items-center px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white rounded-md text-sm"
            >
              Retry now
            </button>
          </div>
        </div>

        <!-- Content Area -->
        <div
          class="flex-1 min-h-0 p-8 overflow-y-auto bg-gray-50 dark:bg-gray-900"
        >
          <!-- Overview View -->
          <div x-show="currentView === 'overview'" x-cloak>
            <!-- Stats Cards -->
            <div
              class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"
            >
              <div
                class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-gray-400 text-sm">Total Sets</p>
                    <p class="text-3xl font-bold mt-2" x-text="sets.length"></p>
                  </div>
                  <div class="bg-amber-600 bg-opacity-20 p-3 rounded-lg">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="w-6 h-6 text-amber-400"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                      aria-hidden="true"
                      data-slot="icon"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M6 6.878V6a2.25 2.25 0 0 1 2.25-2.25h7.5A2.25 2.25 0 0 1 18 6v.878m-12 0c.235-.083.487-.128.75-.128h10.5c.263 0 .515.045.75.128m-12 0A2.25 2.25 0 0 0 4.5 9v.878m13.5-3A2.25 2.25 0 0 1 19.5 9v.878m0 0a2.246 2.246 0 0 0-.75-.128H5.25c-.263 0-.515.045-.75.128m15 0A2.25 2.25 0 0 1 21 12v6a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 18v-6c0-.98.626-1.813 1.5-2.122"
                      />
                    </svg>
                  </div>
                </div>
              </div>

              <div
                class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-gray-400 text-sm">Collections</p>
                    <p
                      class="text-3xl font-bold mt-2"
                      x-text="getTotalCollections()"
                    ></p>
                  </div>
                  <div class="bg-blue-600 bg-opacity-20 p-3 rounded-lg">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="w-6 h-6 text-blue-400"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                      aria-hidden="true"
                      data-slot="icon"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z"
                      />
                    </svg>
                  </div>
                </div>
              </div>

              <div
                class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-gray-400 text-sm">Documents</p>
                    <p
                      class="text-3xl font-bold mt-2"
                      x-text="getTotalDocuments()"
                    ></p>
                  </div>
                  <div class="bg-amber-600 bg-opacity-20 p-3 rounded-lg">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="w-6 h-6 text-amber-400"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                      aria-hidden="true"
                      data-slot="icon"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"
                      />
                    </svg>
                  </div>
                </div>
              </div>

              <div
                class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-gray-400 text-sm">API Calls (24h)</p>
                    <p class="text-3xl font-bold mt-2">—</p>
                  </div>
                  <div class="bg-yellow-600 bg-opacity-20 p-3 rounded-lg">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="w-6 h-6 text-yellow-400"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                      aria-hidden="true"
                      data-slot="icon"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="m3.75 13.5 10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75Z"
                      />
                    </svg>
                  </div>
                </div>
              </div>
            </div>

            <!-- Selected Set Overview -->
            <div class="mt-8" x-show="selectedSet">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold">
                  Selected Set:
                  <span
                    class="text-amber-600"
                    x-text="selectedSet?.name"
                  ></span>
                </h3>
                <div class="text-sm text-gray-500">
                  <span x-text="getSelectedSetDocsCount()"></span>
                  <span>docs</span>
                </div>
              </div>

              <div class="grid grid-cols-12 gap-6">
                <!-- Collections in Set -->
                <div class="col-span-12 lg:col-span-4">
                  <div
                    class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700"
                  >
                    <div
                      class="p-4 border-b border-gray-200 dark:border-gray-700"
                    >
                      <h4 class="font-semibold">Collections</h4>
                    </div>
                    <div class="p-2">
                      <template
                        x-for="collection in (selectedSet?.collections || [])"
                        :key="collection.name"
                      >
                        <button
                          @click="selectedCollection = collection.name; loadCollectionInfo(selectedSet.name, collection.name)"
                          :class="selectedCollection === collection.name ? 'bg-amber-600 text-white' : 'hover:bg-gray-100 dark:hover:bg-gray-700'"
                          class="w-full text-left px-3 py-2 rounded-lg text-sm mb-1 transition-all flex justify-between items-center"
                        >
                          <span x-text="collection.name"></span>
                          <span
                            class="text-xs opacity-60"
                            x-text="collection.count"
                          ></span>
                        </button>
                      </template>
                    </div>
                  </div>
                </div>

                <!-- Schema + Stats for Selected Collection -->
                <div class="col-span-12 lg:col-span-8">
                  <div
                    class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700"
                  >
                    <div
                      class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between"
                    >
                      <div>
                        <h4 class="font-semibold">Schema</h4>
                      </div>
                      <div
                        class="flex items-center gap-2"
                        x-show="selectedCollection"
                      >
                        <template x-if="getSelectedCollectionInfo()?.schema">
                          <button
                            @click="beginSchemaEdit()"
                            class="px-3 py-1.5 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-lg text-sm"
                          >
                            Edit
                          </button>
                        </template>
                        <template x-if="!getSelectedCollectionInfo()?.schema">
                          <button
                            @click="beginSchemaEdit()"
                            class="px-3 py-1.5 bg-amber-600 hover:bg-amber-700 text-white rounded-lg text-sm"
                          >
                            Create
                          </button>
                        </template>
                        <template x-if="getSelectedCollectionInfo()?.schema">
                          <button
                            @click="removeSchema()"
                            :disabled="isSavingSchema"
                            class="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm disabled:opacity-50"
                          >
                            Remove
                          </button>
                        </template>
                      </div>
                    </div>
                    <div class="p-4 space-y-4">
                      <div
                        x-show="!selectedCollection"
                        class="text-sm text-gray-500"
                      >
                        Select a collection to view its schema.
                      </div>

                      <!-- Editor -->
                      <div x-show="isEditingSchema && selectedCollection">
                        <textarea
                          x-model="schemaEditorText"
                          class="w-full h-64 p-3 font-mono text-sm bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-1 focus:ring-amber-600 focus:border-amber-600"
                        ></textarea>
                        <p class="mt-1 text-xs text-gray-500">
                          for help visit
                          <a
                            href="https://json-schema.org/learn/getting-started-step-by-step"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-amber-600 hover:text-amber-700 underline"
                            >https://json-schema.org/learn/getting-started-step-by-step</a
                          >
                        </p>
                        <div class="mt-2 flex items-center gap-2">
                          <button
                            @click="saveSchema()"
                            :disabled="isSavingSchema"
                            class="px-3 py-1.5 bg-amber-600 hover:bg-amber-700 text-white rounded-lg text-sm disabled:opacity-50"
                          >
                            Save
                          </button>
                          <button
                            @click="cancelSchemaEdit()"
                            :disabled="isSavingSchema"
                            class="px-3 py-1.5 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-lg text-sm disabled:opacity-50"
                          >
                            Cancel
                          </button>
                        </div>
                      </div>

                      <!-- Readonly view -->
                      <div x-show="!isEditingSchema && selectedCollection">
                        <template x-if="getSelectedCollectionInfo()?.schema">
                          <pre
                            class="p-3 rounded-lg bg-gray-100 dark:bg-gray-900 overflow-auto text-xs"
                          ><code x-text="JSON.stringify(getSelectedCollectionInfo().schema, null, 2)"></code></pre>
                        </template>
                        <template x-if="!getSelectedCollectionInfo()?.schema">
                          <div class="text-sm text-gray-500">
                            No schema defined for this collection.
                          </div>
                        </template>
                      </div>

                      <hr
                        x-show="selectedCollection"
                        class="my-4 border-t border-gray-200 dark:border-gray-700"
                      />

                      <!-- Indexes -->
                      <div x-show="selectedCollection" class="space-y-3">
                        <div class="flex items-center justify-between">
                          <h5 class="font-semibold">Indexes</h5>
                          <div class="flex items-center gap-2">
                            <button
                              @click="refreshIndexes()"
                              class="px-3 py-1.5 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-lg text-sm"
                            >
                              Refresh
                            </button>
                          </div>
                        </div>
                        <!-- Create index form -->
                        <div class="flex flex-col sm:flex-row gap-2">
                          <input
                            type="text"
                            x-model="indexPathsInput"
                            placeholder="path or comma-separated paths (e.g. $.user.id,$.org.id)"
                            class="flex-1 px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-amber-600 focus:border-amber-600"
                          />
                          <button
                            @click="createIndex()"
                            :disabled="isCreatingIndex"
                            class="px-3 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg text-sm disabled:opacity-50"
                          >
                            Create Index
                          </button>
                        </div>
                        <!-- Indexes list -->
                        <template
                          x-if="!(getSelectedCollectionInfo().indexes && getSelectedCollectionInfo().indexes.length)"
                        >
                          <div class="text-sm text-gray-500">
                            No indexes created yet.
                          </div>
                        </template>
                        <div
                          class="space-y-2"
                          x-show="getSelectedCollectionInfo().indexes && getSelectedCollectionInfo().indexes.length"
                        >
                          <template
                            x-for="idx in (getSelectedCollectionInfo().indexes || [])"
                            :key="idx.name"
                          >
                            <div
                              class="border border-gray-200 dark:border-gray-700 rounded-lg p-3"
                            >
                              <div
                                class="flex items-start justify-between gap-2"
                              >
                                <div>
                                  <div class="flex items-center gap-2">
                                    <span
                                      class="font-medium"
                                      x-text="idx.name"
                                    ></span>
                                    <span
                                      class="text-xs px-2 py-0.5 rounded-full"
                                      :class="{
                                      'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200': idx.status === 'ready',
                                      'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200': idx.status === 'creating',
                                      'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': idx.status === 'error',
                                      'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200': !idx.status
                                    }"
                                      x-text="idx.status || '—'"
                                    ></span>
                                  </div>
                                  <div class="mt-1 flex flex-wrap gap-1">
                                    <template
                                      x-for="p in (idx.paths || [])"
                                      :key="p"
                                    >
                                      <span
                                        class="text-xs px-2 py-0.5 rounded bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-mono"
                                        x-text="p"
                                      ></span>
                                    </template>
                                  </div>
                                  <div
                                    class="mt-1 text-xs text-gray-500 flex flex-wrap gap-3"
                                  >
                                    <div>
                                      usage:
                                      <span
                                        x-text="idx.usage_count || 0"
                                      ></span>
                                    </div>
                                    <div x-show="idx.created_at">
                                      created:
                                      <span
                                        x-text="formatDate(idx.created_at)"
                                      ></span>
                                    </div>
                                    <div x-show="idx.last_used_at">
                                      last used:
                                      <span
                                        x-text="formatDate(idx.last_used_at)"
                                      ></span>
                                    </div>
                                  </div>
                                  <div
                                    class="mt-1 text-xs text-red-600"
                                    x-show="idx.error"
                                    x-text="idx.error"
                                  ></div>
                                </div>
                                <div class="flex items-center gap-2">
                                  <button
                                    @click="deleteIndex(idx)"
                                    :disabled="isDeletingIndex === idx.name"
                                    class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs disabled:opacity-50"
                                  >
                                    Delete
                                  </button>
                                </div>
                              </div>
                            </div>
                          </template>
                        </div>
                      </div>

                      <hr
                        x-show="selectedCollection"
                        class="my-4 border-t border-gray-200 dark:border-gray-700"
                      />

                      <!-- Collection Stats -->
                      <div
                        x-show="selectedCollection"
                        class="text-sm text-gray-600 dark:text-gray-300"
                      >
                        <h5 class="font-semibold mb-1">Statistics</h5>
                        <div class="flex flex-wrap gap-4">
                          <div>
                            <span class="opacity-70">Docs:</span>
                            <span
                              x-text="(getSelectedCollectionInfo()?.stats?.count || 0)"
                            ></span>
                          </div>
                          <div
                            x-show="getSelectedCollectionInfo()?.stats?.created_at"
                          >
                            <span class="opacity-70">Created:</span>
                            <span
                              x-text="getSelectedCollectionInfo()?.stats?.created_at ? formatDate(getSelectedCollectionInfo().stats.created_at) : '—'"
                            ></span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Explorer View -->
          <div x-show="currentView === 'explorer'" x-cloak>
            <div class="grid grid-cols-12 gap-6">
              <!-- Collections List -->
              <div class="col-span-12 lg:col-span-3">
                <div
                  class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700"
                >
                  <div
                    class="p-4 border-b border-gray-200 dark:border-gray-700"
                  >
                    <h3 class="font-semibold">Collections</h3>
                  </div>
                  <div class="p-2">
                    <template
                      x-for="collection in (selectedSet?.collections || [])"
                      :key="collection.name"
                    >
                      <button
                        @click="selectedCollection = collection.name; loadDocuments()"
                        :class="selectedCollection === collection.name ? 'bg-amber-600 text-white' : 'hover:bg-gray-100 dark:hover:bg-gray-700'"
                        class="w-full text-left px-3 py-2 rounded-lg text-sm mb-1 transition-all flex justify-between items-center"
                      >
                        <span x-text="collection.name"></span>
                        <span
                          class="text-xs opacity-60"
                          x-text="collection.count"
                        ></span>
                      </button>
                    </template>
                  </div>
                </div>
              </div>

              <!-- Documents Grid -->
              <div class="col-span-12 lg:col-span-9">
                <div
                  class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700"
                >
                  <div
                    class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center"
                  >
                    <h3 class="font-semibold">Documents</h3>
                    <div class="flex flex-wrap items-center gap-2">
                      <input
                        type="text"
                        placeholder="Search (where JSON)"
                        x-model="queryWhere"
                        class="px-3 py-1.5 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-amber-600 focus:border-amber-600"
                      />
                      <button
                        @click="queryOffset = 0; loadDocuments()"
                        :disabled="isLoadingDocs"
                        class="px-3 py-1.5 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-lg text-sm disabled:opacity-50"
                      >
                        <svg
                          x-show="isLoadingDocs"
                          xmlns="http://www.w3.org/2000/svg"
                          class="w-4 h-4 animate-spin"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke-width="1.5"
                          stroke="currentColor"
                          aria-hidden="true"
                          data-slot="icon"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99"
                          />
                        </svg>
                        <svg
                          x-show="!isLoadingDocs"
                          xmlns="http://www.w3.org/2000/svg"
                          class="w-4 h-4"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke-width="1.5"
                          stroke="currentColor"
                          aria-hidden="true"
                          data-slot="icon"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 0 1-.659 1.591l-5.432 5.432a2.25 2.25 0 0 0-.659 1.591v2.927a2.25 2.25 0 0 1-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 0 0-.659-1.591L3.659 7.409A2.25 2.25 0 0 1 3 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0 1 12 3Z"
                          />
                        </svg>
                      </button>
                      <span class="hidden sm:inline text-xs text-gray-400 ml-2"
                        >Limit</span
                      >
                      <input
                        type="number"
                        min="1"
                        x-model.number="queryLimit"
                        @change="queryOffset = 0; loadDocuments()"
                        class="w-20 px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-amber-600 focus:border-amber-600"
                      />
                      <button
                        @click="prevPage()"
                        :disabled="!canPrev() || isLoadingDocs"
                        class="px-2 py-1 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-lg text-sm disabled:opacity-50"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="w-4 h-4"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke-width="1.5"
                          stroke="currentColor"
                          aria-hidden="true"
                          data-slot="icon"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M15.75 19.5 8.25 12l7.5-7.5"
                          />
                        </svg>
                      </button>
                      <button
                        @click="nextPage()"
                        :disabled="!canNext() || isLoadingDocs"
                        class="px-2 py-1 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-lg text-sm disabled:opacity-50"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="w-4 h-4"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke-width="1.5"
                          stroke="currentColor"
                          aria-hidden="true"
                          data-slot="icon"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="m8.25 4.5 7.5 7.5-7.5 7.5"
                          />
                        </svg>
                      </button>
                      <span
                        x-show="!isLoadingDocs"
                        class="text-xs text-gray-400 ml-2"
                        x-text="`Showing ${getPageStart()}–${getPageEnd()} of ${totalItems}`"
                      ></span>
                    </div>
                  </div>
                  <div class="p-4">
                    <div class="space-y-2">
                      <div
                        x-show="isLoadingDocs"
                        class="text-sm text-gray-500 dark:text-gray-400"
                      >
                        Loading...
                      </div>
                      <template
                        x-for="(doc, i) in documents"
                        :key="doc._meta.id"
                      >
                        <div
                          @click="selectedDocument = doc; documentJson = JSON.stringify(doc, null, 2); showDocumentModal = true"
                          class="p-4 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-opacity-70 rounded-lg cursor-pointer transition-all"
                        >
                          <div class="flex justify-between items-start mb-2">
                            <code
                              class="text-xs text-amber-400"
                              x-text="doc._meta.id"
                            ></code>
                            <div class="flex items-center gap-3">
                              <span
                                class="text-xs text-gray-500"
                                x-text="doc._meta?.created_at ? formatDate(doc._meta.created_at) : ''"
                              ></span>
                              <span
                                class="text-xs text-gray-500"
                                x-text="doc._meta?.updated_at ? '• ' + formatDate(doc._meta.updated_at) : ''"
                              ></span>
                              <button
                                @click.stop="deleteDocumentInline(doc)"
                                class="text-red-400 hover:text-red-300"
                                title="Delete"
                              >
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  class="w-4 h-4"
                                  fill="none"
                                  viewBox="0 0 24 24"
                                  stroke-width="1.5"
                                  stroke="currentColor"
                                  aria-hidden="true"
                                  data-slot="icon"
                                >
                                  <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"
                                  />
                                </svg>
                              </button>
                            </div>
                          </div>
                          <pre
                            class="text-sm text-gray-700 dark:text-gray-300 json-editor overflow-hidden max-h-20"
                            x-text="JSON.stringify(Object.fromEntries(Object.entries(doc).filter(([k]) => k !== '_meta')), null, 2).slice(0, 200)"
                          ></pre>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Query Builder View -->
          <div x-show="currentView === 'query'" x-cloak>
            <div class="max-w-4xl mx-auto">
              <div
                class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700"
              >
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                  <h3 class="text-lg font-semibold mb-4">Query Builder</h3>

                  <!-- Query Input -->
                  <div class="space-y-4">
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-400 mb-2"
                        >Collection Path</label
                      >
                      <input
                        type="text"
                        x-model="queryPath"
                        placeholder="/set/collection"
                        class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-1 focus:ring-amber-600 focus:border-amber-600"
                      />
                    </div>

                    <div>
                      <label
                        class="block text-sm font-medium text-gray-400 mb-2"
                        >Where Clause</label
                      >
                      <textarea
                        x-model="queryWhere"
                        rows="4"
                        placeholder='{"field": {"$gt": 10}}'
                        class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-1 focus:ring-amber-600 focus:border-amber-600 json-editor"
                      ></textarea>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                      <div>
                        <label
                          class="block text-sm font-medium text-gray-400 mb-2"
                          >Order By</label
                        >
                        <input
                          type="text"
                          x-model="queryOrderBy"
                          placeholder="field_name"
                          class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-1 focus:ring-amber-600 focus:border-amber-600"
                        />
                      </div>
                      <div>
                        <label
                          class="block text-sm font-medium text-gray-400 mb-2"
                          >Limit</label
                        >
                        <input
                          type="number"
                          x-model.number="queryLimit"
                          placeholder="10"
                          class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-1 focus:ring-amber-600 focus:border-amber-600"
                        />
                      </div>
                      <div>
                        <label
                          class="block text-sm font-medium text-gray-400 mb-2"
                          >Offset</label
                        >
                        <input
                          type="number"
                          x-model.number="queryOffset"
                          placeholder="0"
                          class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-1 focus:ring-amber-600 focus:border-amber-600"
                        />
                      </div>
                    </div>
                  </div>

                  <button
                    @click="executeQuery()"
                    class="inline-flex items-center mt-6 px-6 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg font-medium transition-colors"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="w-4 h-4 mr-2"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                      aria-hidden="true"
                      data-slot="icon"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z"
                      />
                    </svg>
                    Execute Query
                  </button>
                </div>

                <!-- Results -->
                <div class="p-6">
                  <h4 class="font-semibold mb-3">Results</h4>
                  <div
                    class="bg-gray-900 rounded-lg p-4 max-h-96 overflow-y-auto"
                  >
                    <pre
                      class="text-sm text-gray-300 json-editor"
                      x-text="queryResults"
                    ></pre>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- API Tester View -->
          <div x-show="currentView === 'api'" x-cloak>
            <div class="max-w-5xl mx-auto">
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Request Builder -->
                <div
                  class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700"
                >
                  <div
                    class="p-6 border-b border-gray-200 dark:border-gray-700"
                  >
                    <h3 class="text-lg font-semibold">Request</h3>
                  </div>
                  <div class="p-6 space-y-4">
                    <div class="flex gap-2">
                      <select
                        x-model="apiMethod"
                        class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-1 focus:ring-amber-600 focus:border-amber-600"
                      >
                        <option>GET</option>
                        <option>POST</option>
                        <option>PUT</option>
                        <option>PATCH</option>
                        <option>DELETE</option>
                      </select>
                      <input
                        type="text"
                        x-model="apiEndpoint"
                        placeholder="/set/collection"
                        class="flex-1 px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-1 focus:ring-amber-600 focus:border-amber-600"
                      />
                    </div>

                    <div>
                      <label
                        class="block text-sm font-medium text-gray-400 mb-2"
                        >Headers</label
                      >
                      <textarea
                        x-model="apiHeaders"
                        rows="3"
                        class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-1 focus:ring-amber-600 focus:border-amber-600 json-editor"
                      ></textarea>
                    </div>

                    <div>
                      <label
                        class="block text-sm font-medium text-gray-400 mb-2"
                        >Body</label
                      >
                      <textarea
                        x-model="apiBody"
                        rows="8"
                        class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-1 focus:ring-amber-600 focus:border-amber-600 json-editor"
                      ></textarea>
                    </div>

                    <button
                      @click="sendApiRequest()"
                      class="inline-flex items-center w-full px-6 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg font-medium transition-colors"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-4 h-4 mr-2"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        aria-hidden="true"
                        data-slot="icon"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"
                        />
                      </svg>
                      Send Request
                    </button>
                  </div>
                </div>

                <!-- Response -->
                <div
                  class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700"
                >
                  <div
                    class="p-6 border-b border-gray-200 dark:border-gray-700"
                  >
                    <h3 class="text-lg font-semibold">Response</h3>
                  </div>
                  <div class="p-6">
                    <div
                      class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4 max-h-96 overflow-y-auto"
                    >
                      <pre
                        class="text-sm text-gray-800 dark:text-gray-300 json-editor"
                        x-text="apiResponse"
                      ></pre>
                    </div>

                    <!-- cURL Example -->
                    <div class="mt-6">
                      <label
                        class="block text-sm font-medium text-gray-400 mb-2"
                        >cURL Command</label
                      >
                      <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                        <code
                          class="text-xs text-amber-400"
                          x-text="getCurlCommand()"
                        ></code>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Document Modal -->
    <div
      x-show="showDocumentModal"
      x-cloak
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
    >
      <div
        class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl max-w-2xl w-full max-h-[80vh] overflow-hidden"
        @click.away="showDocumentModal = false"
      >
        <div
          class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center"
        >
          <h3 class="text-lg font-semibold">Document Details</h3>
          <button
            @click="showDocumentModal = false"
            class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-white"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              aria-hidden="true"
              data-slot="icon"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6 18 18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="p-6 overflow-y-auto">
          <textarea
            x-model="documentJson"
            rows="20"
            class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-1 focus:ring-amber-600 focus:border-amber-600 json-editor text-sm"
          ></textarea>
          <div class="mt-4 flex gap-2">
            <button
              @click="saveDocument()"
              :disabled="isSaving"
              class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50"
            >
              <svg
                x-show="isSaving"
                xmlns="http://www.w3.org/2000/svg"
                class="w-4 h-4 mr-2 animate-spin"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
                aria-hidden="true"
                data-slot="icon"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99"
                />
              </svg>
              Save Changes
            </button>
            <button
              @click="deleteDocument()"
              :disabled="isDeleting"
              class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50"
            >
              <svg
                x-show="isDeleting"
                xmlns="http://www.w3.org/2000/svg"
                class="w-4 h-4 mr-2 animate-spin"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
                aria-hidden="true"
                data-slot="icon"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99"
                />
              </svg>
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Health Modal -->
    <div
      x-show="showHealthModal"
      x-cloak
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
    >
      <div
        class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl max-w-2xl w-full max-h-[80vh] overflow-hidden"
        @click.away="showHealthModal = false"
      >
        <div
          class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center"
        >
          <h3 class="text-lg font-semibold">Health Status</h3>
          <button
            @click="showHealthModal = false"
            class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-white"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              aria-hidden="true"
              data-slot="icon"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6 18 18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="p-6 overflow-y-auto">
          <pre
            class="w-full p-4 bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-700 rounded-lg json-editor text-sm"
            x-text="healthResponse || '// No response yet'"
          ></pre>
        </div>
      </div>
    </div>

    <!-- New Document Modal -->
    <div
      x-show="showNewDocModal"
      x-cloak
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
    >
      <div
        class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl max-w-2xl w-full"
        @click.away="showNewDocModal = false"
      >
        <div
          class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center"
        >
          <h3 class="text-lg font-semibold">Create New Document</h3>
          <button
            @click="showNewDocModal = false"
            class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-white"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              aria-hidden="true"
              data-slot="icon"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6 18 18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="p-6">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-400 mb-2"
              >Collection Path</label
            >
            <input
              type="text"
              x-model="newDocPath"
              placeholder="/set/collection"
              class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-1 focus:ring-amber-600 focus:border-amber-600"
            />
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-400 mb-2"
              >Document JSON</label
            >
            <textarea
              x-model="newDocJson"
              rows="10"
              placeholder='{"name": "value"}'
              class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-1 focus:ring-amber-600 focus:border-amber-600 json-editor"
            ></textarea>
          </div>
          <button
            @click="createDocument()"
            :disabled="isCreating"
            class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50"
          >
            <svg
              x-show="isCreating"
              xmlns="http://www.w3.org/2000/svg"
              class="w-4 h-4 mr-2 animate-spin"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              aria-hidden="true"
              data-slot="icon"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99"
              />
            </svg>
            Create Document
          </button>
        </div>
      </div>
    </div>

    <!-- Toasts -->
    <div class="fixed bottom-4 right-4 z-50 space-y-2" x-cloak>
      <template x-for="t in toasts" :key="t.id">
        <div
          class="px-4 py-2 rounded-lg shadow border"
          :class="{
             'bg-amber-100 border-amber-300 text-amber-800 dark:bg-amber-900/60 dark:border-amber-700 dark:text-amber-200': t.type === 'success',
             'bg-red-100 border-red-300 text-red-800 dark:bg-red-900/60 dark:border-red-700 dark:text-red-200': t.type === 'error',
             'bg-gray-100 border-gray-300 text-gray-800 dark:bg-gray-800/80 dark:border-gray-700 dark:text-gray-200': t.type !== 'success' && t.type !== 'error'
           }"
        >
          <span x-text="t.text"></span>
        </div>
      </template>
    </div>

    <script>
      function dashboard() {
        return {
          // Views / Selections
          currentView: "explorer",
          sets: [], // [{ name, colls?, docs?, collections: [{name, count}] }]
          setsStats: { total_docs: 0 },
          collectionInfos: {}, // { [set]: { [collection]: { schema, indexes, stats } } }
          // Schema editor state (Overview)
          isEditingSchema: false,
          schemaEditorText: "",
          isSavingSchema: false,
          schemaSource: "",
          // Indexes state (Overview)
          indexPathsInput: "",
          isCreatingIndex: false,
          isDeletingIndex: null,
          selectedSet: null, // { name, collections }
          selectedCollection: "",
          documents: [],
          // Modals
          selectedDocument: null,
          showDocumentModal: false,
          showNewDocModal: false,
          showHealthModal: false,
          documentJson: "",
          newDocPath: "",
          newDocJson: "{\n  \n}",

          // Query Builder
          queryPath: "",
          queryWhere: "",
          queryOrderBy: "",
          queryLimit: 10,
          queryOffset: 0,
          queryResults: "",

          // API Tester
          apiMethod: "GET",
          apiEndpoint: "",
          apiHeaders: '{\n  "Content-Type": "application/json"\n}',
          apiBody: "{\n}\n",
          apiResponse: "",

          // Health
          healthResponse: "",
          serverVersion: "",
          healthOk: null,
          lastHealthError: "",
          healthTimerId: null,

          // Loading / actions
          isLoadingDocs: false,
          isSaving: false,
          isDeleting: false,
          isCreating: false,

          // Toasts
          toasts: [],
          toastSeq: 0,
          // Pagination total (filtered)
          totalItems: 0,

          async init() {
            // Initialize Alpine state from actual DOM class set in <head>
            try {
              this.isDark = document.documentElement.classList.contains("dark");
            } catch {}
            // Kick off health checks
            this.checkHealth();
            this.healthTimerId = setInterval(() => {
              this.checkHealth();
            }, 15000);
            await this.loadSets();
            if (this.sets.length) {
              await this.selectSet(this.sets[0]);
            }
          },
          // Theme state
          isDark: true,

          getTitle() {
            const titles = {
              overview: "Dashboard Overview",
              explorer: "Data Explorer",
              query: "Query Builder",
              api: "API Tester",
            };
            return titles[this.currentView] || "Dashboard";
          },

          toggleTheme() {
            this.isDark = !this.isDark;
            const next = this.isDark ? "dark" : "light";
            if (window.setTheme) {
              window.setTheme(next);
            } else {
              // Fallback if helper missing
              try {
                localStorage.setItem("theme", next);
              } catch {}
              document.documentElement.classList.toggle("dark", this.isDark);
            }
          },

          // Health checks
          openHealthModal() {
            this.showHealthModal = true;
            this.checkHealth();
          },
          async checkHealth() {
            try {
              const r = await fetch("/health");
              const text = await r.text();
              let pretty = text;
              let j;
              try {
                j = JSON.parse(text);
              } catch {}
              if (j) pretty = JSON.stringify(j, null, 2);

              if (this.serverVersion !== (j && j.data && j.data.version)) {
                this.serverVersion = j.data.version;
              }
              const ok = r.ok && !(j && j.success === false);
              this.healthOk = ok;
              if (!ok) {
                this.lastHealthError =
                  (j && (j.error || j.message)) ||
                  text ||
                  r.status + " " + r.statusText;
              } else {
                this.lastHealthError = "";
              }
              this.healthResponse = pretty;
            } catch (e) {
              this.healthOk = false;
              this.lastHealthError = String(e);
            }
          },

          // Data loading
          async loadSets() {
            try {
              const r = await fetch("/_sets");
              const j = await r.json();
              if (j && j.success && j.data && j.data.sets) {
                const data = j.data || {};
                const setsMap = data.sets || {};
                this.sets = Object.entries(setsMap).map(([name, v]) => ({
                  name,
                  colls: (v && (v.colls ?? v.colls)) || 0,
                  docs: (v && (v.docs ?? v.docs)) || 0,
                  collections: [],
                }));
                this.setsStats = data.stats || { total_docs: 0 };
              } else {
                const names =
                  j && j.success ? j.data : Array.isArray(j) ? j : [];
                this.sets = (names || []).map((name) => ({
                  name,
                  collections: [],
                }));
                this.setsStats = { total_docs: 0 };
              }
            } catch (e) {
              console.error("loadSets error", e);
              this.sets = [];
              this.setsStats = { total_docs: 0 };
            }
          },

          async selectSet(set) {
            this.selectedSet = set;
            this.selectedCollection = "";
            await this.refreshSelectedSet();
            if (this.selectedSet.collections.length) {
              this.selectedCollection = this.selectedSet.collections[0].name;
              await this.loadDocuments();
              await this.loadCollectionInfo(
                this.selectedSet.name,
                this.selectedCollection
              );
              this.isEditingSchema = false;
            }
          },

          async refreshSelectedSet() {
            if (!this.selectedSet?.name) return;
            try {
              const r = await fetch("/" + this.selectedSet.name);
              const j = await r.json();
              const stats = j && j.success ? j.data : {};
              this.selectedSet.collections = Object.entries(stats).map(
                ([name, v]) => ({
                  name,
                  count: (v && (v.count ?? v?.docs ?? 0)) || 0,
                })
              );
            } catch (e) {
              console.error("refreshSelectedSet error", e);
              this.selectedSet.collections = [];
            }
          },

          async loadDocuments() {
            if (!this.selectedSet?.name || !this.selectedCollection) return;
            try {
              this.isLoadingDocs = true;
              const params = new URLSearchParams();
              if (this.queryWhere) params.set("where", this.queryWhere);
              if (this.queryOrderBy) params.set("order_by", this.queryOrderBy);
              if (this.queryLimit) params.set("limit", this.queryLimit);
              params.set("offset", this.queryOffset || 0);
              const url =
                `/${this.selectedSet.name}/${this.selectedCollection}?` +
                params.toString();
              const r = await fetch(url);
              const ti = parseInt(r.headers.get("X-Total-Items") || "0", 10);
              this.totalItems = Number.isFinite(ti) ? ti : 0;
              const j = await r.json();
              this.documents = j && j.success ? j.data || [] : [];
            } catch (e) {
              console.error("loadDocuments error", e);
              this.documents = [];
              this.showToast("Failed to load documents", "error");
            } finally {
              this.isLoadingDocs = false;
            }
          },

          // Query Builder
          async executeQuery() {
            try {
              const path = (
                this.queryPath ||
                `${this.selectedSet?.name || ""}/${
                  this.selectedCollection || ""
                }`
              ).replace(/^\/+/, "");
              if (!path) {
                this.queryResults = "// Set a collection path";
                return;
              }
              const params = new URLSearchParams();
              if (this.queryWhere) params.set("where", this.queryWhere);
              if (this.queryOrderBy) params.set("order_by", this.queryOrderBy);
              if (this.queryLimit) params.set("limit", this.queryLimit);
              params.set("offset", this.queryOffset || 0);
              const r = await fetch(`/${path}?` + params.toString());
              const j = await r.json();
              this.queryResults = JSON.stringify(j, null, 2);
            } catch (e) {
              this.queryResults = JSON.stringify(
                { success: false, error: String(e) },
                null,
                2
              );
            }
          },

          async loadCollectionInfo(setName, collectionName) {
            if (!setName || !collectionName) return;
            try {
              const r = await fetch(`/${setName}/${collectionName}/_info`);
              const j = await r.json();
              if (j && j.success) {
                if (!this.collectionInfos[setName])
                  this.collectionInfos[setName] = {};
                this.collectionInfos[setName][collectionName] = j.data || {};
              }
            } catch (e) {
              console.error("loadCollectionInfo error", e);
            }
          },

          getSelectedSetDocsCount() {
            if (!this.selectedSet) return 0;
            if (Number.isFinite(this.selectedSet.docs))
              return this.selectedSet.docs || 0;
            return (this.selectedSet.collections || []).reduce(
              (c, col) => c + (col.count || 0),
              0
            );
          },

          getSelectedCollectionInfo() {
            const setName = this.selectedSet?.name;
            const coll = this.selectedCollection;
            return (
              (setName && coll && this.collectionInfos[setName]?.[coll]) || {}
            );
          },

          // Schema editor actions
          async beginSchemaEdit() {
            const info = this.getSelectedCollectionInfo();
            const schema = info?.schema;
            if (schema) {
              this.schemaEditorText = JSON.stringify(schema, null, 2);
              this.schemaSource = "existing";
              this.isEditingSchema = true;
              return;
            }
            // No schema: first try to infer from first document (skipping _meta). If none, use example template.
            let sample = null;
            if (Array.isArray(this.documents) && this.documents.length > 0) {
              sample = this.documents[0];
            } else if (this.selectedSet?.name && this.selectedCollection) {
              try {
                const params = new URLSearchParams();
                params.set("limit", 1);
                const r = await fetch(
                  `/${this.selectedSet.name}/${this.selectedCollection}?` +
                    params.toString()
                );
                const j = await r.json();
                if (j && j.success && Array.isArray(j.data) && j.data.length) {
                  sample = j.data[0];
                }
              } catch (e) {
                // ignore fetch errors, we'll fall back to template
              }
            }
            let finalSchema;
            if (sample && typeof sample === "object" && sample !== null) {
              const inferred = this.inferSchemaFromSample(sample);
              finalSchema = {
                $schema: "https://json-schema.org/draft/2020-12/schema",
                title: this.selectedCollection || "Document",
                ...(inferred && inferred.type === "object"
                  ? { ...inferred, additionalProperties: false }
                  : {
                      type: "object",
                      additionalProperties: false,
                      properties: {},
                    }),
              };
              this.schemaSource = "sample";
            } else {
              finalSchema = {
                $schema: "https://json-schema.org/draft/2020-12/schema",
                title: this.selectedCollection || "Document",
                type: "object",
                additionalProperties: false,
                properties: {
                  name: {
                    type: "string",
                    description: "this is sample data, review it",
                  },
                  surname: {
                    type: "string",
                    description: "this is sample data, review it",
                  },
                  email: {
                    type: "string",
                    description: "this is sample data, review it",
                  },
                  age: {
                    type: "integer",
                    description: "Age in years",
                  },
                },
                required: ["name", "surname", "email", "age"],
              };
              this.schemaSource = "example";
            }
            this.isEditingSchema = true;
            this.schemaEditorText = JSON.stringify(finalSchema, null, 2);
          },

          inferSchemaFromSample(value) {
            const typeOf = (v) => {
              if (v === null) return "null";
              if (Array.isArray(v)) return "array";
              return typeof v;
            };
            const dedupe = (arr) => {
              const seen = new Set();
              const out = [];
              for (const s of arr) {
                const key = JSON.stringify(s);
                if (!seen.has(key)) {
                  seen.add(key);
                  out.push(s);
                }
              }
              return out;
            };
            const infer = (v) => {
              const t = typeOf(v);
              if (t === "null" || t === "undefined") return null;
              if (t === "string") return { type: "string" };
              if (t === "number")
                return Number.isInteger(v)
                  ? { type: "integer" }
                  : { type: "number" };
              if (t === "boolean") return { type: "boolean" };
              if (t === "array") {
                const itemSchemas = dedupe(
                  (v || []).map((el) => infer(el)).filter(Boolean)
                );
                if (itemSchemas.length === 0) return { type: "array" };
                if (itemSchemas.length === 1)
                  return { type: "array", items: itemSchemas[0] };
                return { type: "array", items: { anyOf: itemSchemas } };
              }
              if (t === "object") {
                const props = {};
                const req = [];
                for (const [k, val] of Object.entries(v || {})) {
                  if (k === "_meta") continue; // skip meta properties
                  const child = infer(val);
                  if (child) {
                    props[k] = child;
                    if (val !== null && val !== undefined) req.push(k);
                  }
                }
                return { type: "object", properties: props, required: req };
              }
              return null;
            };
            return (
              infer(value) || { type: "object", properties: {}, required: [] }
            );
          },
          cancelSchemaEdit() {
            this.isEditingSchema = false;
            this.schemaEditorText = "";
            this.schemaSource = "";
          },
          async saveSchema() {
            if (!this.selectedSet?.name || !this.selectedCollection) return;
            let parsed;
            try {
              parsed = JSON.parse(this.schemaEditorText || "null");
            } catch (e) {
              this.showToast("Invalid JSON schema", "error");
              return;
            }
            try {
              this.isSavingSchema = true;
              const r = await fetch(
                `/${this.selectedSet.name}/${this.selectedCollection}/_schema`,
                {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: parsed === null ? "null" : JSON.stringify(parsed),
                }
              );
              const j = await r.json();
              if (j && j.success) {
                if (!this.collectionInfos[this.selectedSet.name])
                  this.collectionInfos[this.selectedSet.name] = {};
                if (
                  !this.collectionInfos[this.selectedSet.name][
                    this.selectedCollection
                  ]
                )
                  this.collectionInfos[this.selectedSet.name][
                    this.selectedCollection
                  ] = {};
                this.collectionInfos[this.selectedSet.name][
                  this.selectedCollection
                ].schema = j.data?.schema ?? null;
                this.isEditingSchema = false;
                this.schemaEditorText = "";
                this.showToast("Schema saved", "success");
              } else {
                this.showToast(j?.error || "Failed to save schema", "error");
              }
            } catch (e) {
              this.showToast("Failed to save schema", "error");
            } finally {
              this.isSavingSchema = false;
            }
          },
          async removeSchema() {
            if (!this.selectedSet?.name || !this.selectedCollection) return;
            try {
              this.isSavingSchema = true;
              const r = await fetch(
                `/${this.selectedSet.name}/${this.selectedCollection}/_schema`,
                {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: "null",
                }
              );
              const j = await r.json();
              if (j && j.success) {
                if (!this.collectionInfos[this.selectedSet.name])
                  this.collectionInfos[this.selectedSet.name] = {};
                if (
                  !this.collectionInfos[this.selectedSet.name][
                    this.selectedCollection
                  ]
                )
                  this.collectionInfos[this.selectedSet.name][
                    this.selectedCollection
                  ] = {};
                this.collectionInfos[this.selectedSet.name][
                  this.selectedCollection
                ].schema = null;
                this.isEditingSchema = false;
                this.schemaEditorText = "";
                this.showToast("Schema removed", "success");
              } else {
                this.showToast(j?.error || "Failed to remove schema", "error");
              }
            } catch (e) {
              this.showToast("Failed to remove schema", "error");
            } finally {
              this.isSavingSchema = false;
            }
          },

          // Indexes actions
          async refreshIndexes() {
            const setName = this.selectedSet?.name;
            const coll = this.selectedCollection;
            if (!setName || !coll) return;
            try {
              const r = await fetch(`/${setName}/${coll}/_indexes`);
              const j = await r.json();
              if (j && j.success) {
                if (!this.collectionInfos[setName])
                  this.collectionInfos[setName] = {};
                if (!this.collectionInfos[setName][coll])
                  this.collectionInfos[setName][coll] = {};
                this.collectionInfos[setName][coll].indexes = j.data || [];
              }
            } catch (e) {
              console.error("refreshIndexes error", e);
              this.showToast("Failed to load indexes", "error");
            }
          },
          async createIndex() {
            const setName = this.selectedSet?.name;
            const coll = this.selectedCollection;
            const input = (this.indexPathsInput || "").trim();
            if (!setName || !coll || !input) return;
            let body = {};
            if (input.includes(",")) {
              const paths = input
                .split(",")
                .map((s) => s.trim())
                .filter(Boolean);
              if (!paths.length) {
                this.showToast("Provide at least one path", "error");
                return;
              }
              body = { paths };
            } else {
              body = { path: input };
            }
            try {
              this.isCreatingIndex = true;
              const r = await fetch(`/${setName}/${coll}/_index`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body),
              });
              const j = await r.json();
              if (j && j.success) {
                this.showToast("Index creation started", "success");
                this.indexPathsInput = "";
                await this.refreshIndexes();
                // refresh once more after a short delay to catch async ready status
                setTimeout(() => {
                  this.refreshIndexes();
                }, 1200);
              } else {
                this.showToast(j?.error || "Failed to create index", "error");
              }
            } catch (e) {
              this.showToast("Failed to create index", "error");
            } finally {
              this.isCreatingIndex = false;
            }
          },
          async deleteIndex(idx) {
            const setName = this.selectedSet?.name;
            const coll = this.selectedCollection;
            if (!setName || !coll || !idx) return;
            try {
              this.isDeletingIndex = idx.name;
              const paths = (idx.paths || []).join(",");
              const q = new URLSearchParams();
              if (paths) q.set("paths", paths);
              const anyPath = encodeURIComponent(
                (idx.paths && idx.paths[0]) || "path"
              );
              const r = await fetch(
                `/${setName}/${coll}/_index/${anyPath}?` + q.toString(),
                { method: "DELETE" }
              );
              const j = await r.json();
              if (j && j.success) {
                this.showToast("Index deleted", "success");
                await this.refreshIndexes();
              } else {
                this.showToast(j?.error || "Failed to delete index", "error");
              }
            } catch (e) {
              this.showToast("Failed to delete index", "error");
            } finally {
              this.isDeletingIndex = null;
            }
          },

          // API Tester
          async sendApiRequest() {
            try {
              const method = (this.apiMethod || "GET").toUpperCase();
              const endpoint = (this.apiEndpoint || "/").startsWith("/")
                ? this.apiEndpoint
                : "/" + this.apiEndpoint;
              let headers = {};
              try {
                headers = this.apiHeaders ? JSON.parse(this.apiHeaders) : {};
              } catch {
                headers = {};
              }
              const init = { method, headers };
              if (method !== "GET" && method !== "HEAD") {
                init.body = this.apiBody || "";
              }
              const r = await fetch(endpoint, init);
              const text = await r.text();
              try {
                this.apiResponse = JSON.stringify(JSON.parse(text), null, 2);
              } catch {
                this.apiResponse = text;
              }
            } catch (e) {
              this.apiResponse = JSON.stringify(
                { success: false, error: String(e) },
                null,
                2
              );
            }
          },

          getCurlCommand() {
            const method = (this.apiMethod || "GET").toUpperCase();
            const endpoint = (this.apiEndpoint || "/").startsWith("/")
              ? this.apiEndpoint
              : "/" + this.apiEndpoint;
            let cmd = `curl -X ${method} \\\n  ${location.origin}${endpoint}`;
            try {
              const headers = this.apiHeaders
                ? JSON.parse(this.apiHeaders)
                : {};
              for (const [k, v] of Object.entries(headers)) {
                cmd += ` \\\n  -H '${k}: ${v}'`;
              }
            } catch {}
            if (method !== "GET" && method !== "HEAD" && this.apiBody) {
              cmd += ` \\\n  -d '${this.apiBody.replace(/\n/g, "")}'`;
            }
            return cmd;
          },

          // Document actions
          async saveDocument() {
            try {
              if (!this.selectedSet?.name || !this.selectedCollection) {
                alert("Select a set and collection first");
                return;
              }
              const id = this.selectedDocument?._meta?.id;
              if (!id) {
                alert("Cannot determine document id");
                return;
              }
              let bodyObj;
              try {
                bodyObj = this.documentJson
                  ? JSON.parse(this.documentJson)
                  : {};
              } catch (e) {
                alert("Invalid JSON: " + e.message);
                return;
              }

              // ID mismatch guard
              const bodyId =
                (bodyObj && (bodyObj._meta?.id ?? bodyObj.id ?? bodyObj._id)) ||
                null;
              if (bodyId && bodyId !== id) {
                if (
                  !confirm(
                    "The id in the JSON differs from the selected document id. Save to the original id anyway?"
                  )
                ) {
                  return;
                }
              }

              const url = `/${this.selectedSet.name}/${
                this.selectedCollection
              }/${encodeURIComponent(id)}`;
              this.isSaving = true;
              const r = await fetch(url, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(bodyObj),
              });
              const j = await r.json().catch(() => ({}));
              if (!r.ok || (j && j.success === false)) {
                this.showToast("Save failed", "error");
                this.isSaving = false;
                return;
              }
              this.showDocumentModal = false;
              await this.refreshSelectedSet();
              await this.loadDocuments();
              this.showToast("Document saved", "success");
            } catch (e) {
              alert("Save error: " + e.message);
            } finally {
              this.isSaving = false;
            }
          },
          async deleteDocument() {
            try {
              if (!this.selectedSet?.name || !this.selectedCollection) {
                alert("Select a set and collection first");
                return;
              }
              const id = this.selectedDocument?._meta?.id;
              if (!id) {
                alert("Cannot determine document id");
                return;
              }
              if (!confirm("Delete this document?")) return;

              const url = `/${this.selectedSet.name}/${
                this.selectedCollection
              }/${encodeURIComponent(id)}`;
              this.isDeleting = true;
              const r = await fetch(url, { method: "DELETE" });
              const j = await r.json().catch(() => ({}));
              if (!r.ok || (j && j.success === false)) {
                this.showToast("Delete failed", "error");
                this.isDeleting = false;
                return;
              }
              this.showDocumentModal = false;
              await this.refreshSelectedSet();
              await this.loadDocuments();
              this.showToast("Document deleted", "success");
            } catch (e) {
              alert("Delete error: " + e.message);
            } finally {
              this.isDeleting = false;
            }
          },

          // Create document
          async createDocument() {
            try {
              const pathRaw = (
                this.newDocPath ||
                `${this.selectedSet?.name || ""}/${
                  this.selectedCollection || ""
                }`
              ).replace(/^\/+/, "");
              if (!pathRaw) {
                alert("Please set a collection path");
                return;
              }
              const body = JSON.parse(this.newDocJson || "{}");
              this.isCreating = true;
              const r = await fetch(`/${pathRaw}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body),
              });
              const j = await r.json();
              if (j && j.success) {
                this.showNewDocModal = false;
                await this.refreshSelectedSet();
                await this.loadDocuments();
                this.showToast("Document created", "success");
              } else {
                this.showToast("Create failed", "error");
              }
            } catch (e) {
              alert("Invalid JSON or request failed: " + e.message);
            } finally {
              this.isCreating = false;
            }
          },

          // Inline delete from list
          async deleteDocumentInline(doc) {
            try {
              const id = doc?._meta?.id;
              if (!this.selectedSet?.name || !this.selectedCollection || !id)
                return;
              if (!confirm("Delete this document?")) return;
              const url = `/${this.selectedSet.name}/${
                this.selectedCollection
              }/${encodeURIComponent(id)}`;
              const r = await fetch(url, { method: "DELETE" });
              const j = await r.json().catch(() => ({}));
              if (!r.ok || (j && j.success === false)) {
                this.showToast("Delete failed", "error");
                return;
              }
              await this.refreshSelectedSet();
              await this.loadDocuments();
              this.showToast("Document deleted", "success");
            } catch (e) {
              this.showToast("Delete error", "error");
            }
          },

          // Utils
          getTotalCollections() {
            // Prefer aggregated 'colls' from /_sets; fallback to loaded collections
            const viaColls = this.sets.reduce(
              (sum, s) => sum + (s.colls || 0),
              0
            );
            if (viaColls > 0) return viaColls;
            return this.sets.reduce(
              (sum, s) => sum + (s.collections?.length || 0),
              0
            );
          },
          getTotalDocuments() {
            // Prefer server-provided total docs; fallback to per-set docs, then per-collection counts
            const sd = Number(this.setsStats?.total_docs || 0);
            if (sd > 0) return sd;
            const viaSets = this.sets.reduce(
              (sum, s) => sum + (s.docs || 0),
              0
            );
            if (viaSets > 0) return viaSets;
            return this.sets.reduce(
              (sum, s) =>
                sum +
                (s.collections || []).reduce(
                  (c, col) => c + (col.count || 0),
                  0
                ),
              0
            );
          },
          formatDate(ts) {
            try {
              const ms = ts < 1e12 ? ts * 1000 : ts; // support seconds or ms
              return new Date(ms).toLocaleString();
            } catch {
              return "";
            }
          },

          // Pagination helpers
          getSelectedCollectionCount() {
            const col = (this.selectedSet?.collections || []).find(
              (c) => c.name === this.selectedCollection
            );
            return col?.count || 0;
          },
          canPrev() {
            return (this.queryOffset || 0) > 0;
          },
          canNext() {
            const total = this.totalItems || 0;
            return (
              total > (this.queryOffset || 0) + (this.documents?.length || 0)
            );
          },
          getPageStart() {
            const total = this.totalItems || 0;
            if (total === 0) return 0;
            return (this.queryOffset || 0) + 1;
          },
          getPageEnd() {
            const total = this.totalItems || 0;
            const end = (this.queryOffset || 0) + (this.documents?.length || 0);
            return Math.min(total, end);
          },
          nextPage() {
            this.queryOffset =
              (this.queryOffset || 0) + (this.queryLimit || 10);
            this.loadDocuments();
          },
          prevPage() {
            this.queryOffset = Math.max(
              0,
              (this.queryOffset || 0) - (this.queryLimit || 10)
            );
            this.loadDocuments();
          },

          // Toast helpers
          showToast(text, type = "info") {
            const id = ++this.toastSeq;
            this.toasts.push({ id, text, type });
            setTimeout(() => {
              this.toasts = this.toasts.filter((t) => t.id !== id);
            }, 3000);
          },
        };
      }
    </script>
  </body>
</html>
